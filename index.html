<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Debug - Datos de MercadoLibre</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: Arial, sans-serif;
            background: #1a1a1a;
            color: #fff;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        h1 {
            color: #FFE600;
            margin-bottom: 20px;
        }

        button {
            background: #3483FA;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 16px;
            margin-bottom: 20px;
            margin-right: 10px;
        }

        button:hover {
            background: #2968c8;
        }

        .filter-buttons {
            margin: 20px 0;
            padding: 15px;
            background: #2a2a2a;
            border-radius: 8px;
        }

        .filter-buttons button {
            margin: 5px;
        }

        .stats {
            background: #2a2a2a;
            padding: 15px;
            border-radius: 8px;
            margin: 20px 0;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }

        .stat-box {
            background: #1a1a1a;
            padding: 15px;
            border-radius: 6px;
            text-align: center;
        }

        .stat-number {
            font-size: 32px;
            font-weight: bold;
            color: #FFE600;
        }

        .stat-label {
            color: #aaa;
            margin-top: 5px;
        }

        .order-card {
            background: #2a2a2a;
            border: 1px solid #444;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .order-header {
            border-bottom: 2px solid #FFE600;
            padding-bottom: 10px;
            margin-bottom: 15px;
        }

        .order-id {
            font-size: 18px;
            font-weight: bold;
            color: #FFE600;
        }

        .data-row {
            display: grid;
            grid-template-columns: 200px 1fr;
            gap: 10px;
            padding: 8px 0;
            border-bottom: 1px solid #333;
        }

        .data-label {
            font-weight: bold;
            color: #aaa;
        }

        .data-value {
            color: #fff;
        }

        .json-data {
            background: #1a1a1a;
            border: 1px solid #444;
            border-radius: 4px;
            padding: 15px;
            margin-top: 15px;
            overflow-x: auto;
        }

        pre {
            color: #0f0;
            font-size: 12px;
            white-space: pre-wrap;
            word-wrap: break-word;
        }

        .loading {
            text-align: center;
            padding: 40px;
            font-size: 20px;
        }

        .error {
            background: #f44336;
            color: white;
            padding: 15px;
            border-radius: 6px;
            margin-bottom: 20px;
        }

        .hidden {
            display: none;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîç DEBUG - Datos RAW de MercadoLibre</h1>
        
        <button onclick="conectar()">Conectar con MercadoLibre</button>
        <button onclick="cargarDatos()" id="loadBtn" style="display:none;">Cargar √öltimas 30 Ventas</button>
        <button onclick="cargarSoloFlex()" id="loadFlexBtn" style="display:none; background:#FF6B00;">üèçÔ∏è Cargar 50 FLEX</button>
        
        <div id="filterSection" class="filter-buttons hidden">
            <h3 style="color: #FFE600; margin-bottom: 10px;">üîç Filtrar por estado:</h3>
            <button onclick="filtrarPor('all')" style="background:#3483FA;">üìä TODOS</button>
            <button onclick="filtrarPor('pending')" style="background:#FFA500;">üìã PENDIENTES</button>
            <button onclick="filtrarPor('in_transit')" style="background:#00d9ff;">üöö EN CAMINO</button>
            <button onclick="filtrarPor('delivered')" style="background:#00ff88;">‚úÖ ENTREGADOS</button>
        </div>

        <div id="stats" class="stats hidden"></div>
        <div id="content"></div>
    </div>

    <script>
        const CONFIG = {
            CLIENT_ID: '6723747350775490',
            CLIENT_SECRET: 'IpbZNxEJHqaOqou9rVJWs6F2tlswCfX5',
            REDIRECT_URI: window.location.origin + window.location.pathname,
            API_BASE: 'https://mikra-flex-proxy.rafaelassir.workers.dev/api'
        };

        let accessToken = localStorage.getItem('ml_access_token');
        let sellerId = localStorage.getItem('ml_seller_id');
        let allFlexOrders = []; // Store all loaded orders

        function init() {
            const urlParams = new URLSearchParams(window.location.search);
            const code = urlParams.get('code');

            if (code) {
                handleAuthCallback(code);
            } else if (accessToken && sellerId) {
                document.getElementById('loadBtn').style.display = 'inline-block';
                document.getElementById('loadFlexBtn').style.display = 'inline-block';
            }
        }

        function conectar() {
            const authUrl = `https://auth.mercadolibre.com.ar/authorization?response_type=code&client_id=${CONFIG.CLIENT_ID}&redirect_uri=${CONFIG.REDIRECT_URI}`;
            window.location.href = authUrl;
        }

        async function handleAuthCallback(code) {
            const content = document.getElementById('content');
            content.innerHTML = '<div class="loading">Autenticando...</div>';

            try {
                const response = await fetch(`${CONFIG.API_BASE}/oauth/token`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded'
                    },
                    body: new URLSearchParams({
                        grant_type: 'authorization_code',
                        client_id: CONFIG.CLIENT_ID,
                        client_secret: CONFIG.CLIENT_SECRET,
                        code: code,
                        redirect_uri: CONFIG.REDIRECT_URI
                    })
                });

                const data = await response.json();
                accessToken = data.access_token;
                localStorage.setItem('ml_access_token', accessToken);

                const userResponse = await fetch(`${CONFIG.API_BASE}/users/me`, {
                    headers: {
                        'Authorization': `Bearer ${accessToken}`
                    }
                });

                const userData = await userResponse.json();
                sellerId = userData.id;
                localStorage.setItem('ml_seller_id', sellerId);

                content.innerHTML = '<div class="loading">‚úÖ Conectado! Ahora carg√° las ventas</div>';
                document.getElementById('loadBtn').style.display = 'inline-block';
                document.getElementById('loadFlexBtn').style.display = 'inline-block';

                window.history.replaceState({}, document.title, window.location.pathname);
            } catch (error) {
                content.innerHTML = `<div class="error">Error: ${error.message}</div>`;
            }
        }

        async function cargarSoloFlex() {
            const content = document.getElementById('content');
            content.innerHTML = '<div class="loading">üîç Cargando ventas FLEX (OPTIMIZADO - mucho m√°s r√°pido)...</div>';
            
            allFlexOrders = []; // Reset

            try {
                const targetCount = 50;
                let offset = 0;
                const limit = 50;
                let totalChecked = 0;

                // OPTIMIZACI√ìN: Fetch en paralelo por batches
                while (allFlexOrders.length < targetCount && totalChecked < 500) {
                    content.innerHTML = `<div class="loading">üîç Cargando FLEX...<br>Encontradas: <strong style="color:#0f0;">${allFlexOrders.length}/${targetCount}</strong><br>Revisadas: ${totalChecked}</div>`;

                    const response = await fetch(`${CONFIG.API_BASE}/orders/search?seller=${sellerId}&offset=${offset}&limit=${limit}&sort=date_desc`, {
                        headers: {
                            'Authorization': `Bearer ${accessToken}`
                        }
                    });

                    const data = await response.json();
                    
                    if (!data.results || data.results.length === 0) break;

                    totalChecked += data.results.length;

                    // OPTIMIZACI√ìN: Fetch ALL shippings in parallel
                    const shippingPromises = data.results.map(async (order) => {
                        try {
                            const shippingId = order.shipping?.id;
                            if (!shippingId) return null;

                            const shipResponse = await fetch(`${CONFIG.API_BASE}/shipments/${shippingId}`, {
                                headers: {
                                    'Authorization': `Bearer ${accessToken}`
                                }
                            });

                            const shipping = await shipResponse.json();
                            
                            if (shipping.logistic_type === 'self_service') {
                                return { order, shipping };
                            }
                            return null;
                        } catch (e) {
                            return null;
                        }
                    });

                    const results = await Promise.all(shippingPromises);
                    const flexBatch = results.filter(item => item !== null);
                    
                    allFlexOrders.push(...flexBatch);

                    if (allFlexOrders.length >= targetCount) {
                        allFlexOrders = allFlexOrders.slice(0, targetCount);
                        break;
                    }

                    offset += limit;
                }

                console.log(`üèçÔ∏è ${allFlexOrders.length} ventas FLEX de ${totalChecked} revisadas`);

                if (allFlexOrders.length === 0) {
                    content.innerHTML = '<div class="error">No se encontraron ventas FLEX</div>';
                    return;
                }

                // Show filters
                document.getElementById('filterSection').classList.remove('hidden');
                
                // Display all by default
                displayOrders(allFlexOrders, 'all');

            } catch (error) {
                content.innerHTML = `<div class="error">‚ùå Error: ${error.message}</div>`;
                console.error(error);
            }
        }

        function filtrarPor(filter) {
            let filtered = allFlexOrders;

            if (filter === 'pending') {
                filtered = allFlexOrders.filter(({ shipping }) => {
                    const status = (shipping.status || '').toLowerCase();
                    return status === 'ready_to_ship' || status === 'pending';
                });
            } else if (filter === 'in_transit') {
                filtered = allFlexOrders.filter(({ shipping }) => {
                    const status = (shipping.status || '').toLowerCase();
                    return status === 'shipped' || status === 'handling';
                });
            } else if (filter === 'delivered') {
                filtered = allFlexOrders.filter(({ shipping }) => {
                    const status = (shipping.status || '').toLowerCase();
                    return status === 'delivered';
                });
            }

            displayOrders(filtered, filter);
        }

        function displayOrders(orders, filterType) {
            // Calculate stats
            const stats = {
                total: allFlexOrders.length,
                pending: allFlexOrders.filter(({ shipping }) => {
                    const status = (shipping.status || '').toLowerCase();
                    return status === 'ready_to_ship' || status === 'pending';
                }).length,
                in_transit: allFlexOrders.filter(({ shipping }) => {
                    const status = (shipping.status || '').toLowerCase();
                    return status === 'shipped' || status === 'handling';
                }).length,
                delivered: allFlexOrders.filter(({ shipping }) => {
                    const status = (shipping.status || '').toLowerCase();
                    return status === 'delivered';
                }).length
            };

            // Show stats
            const statsHtml = `
                <div class="stat-box">
                    <div class="stat-number">${stats.total}</div>
                    <div class="stat-label">Total FLEX</div>
                </div>
                <div class="stat-box">
                    <div class="stat-number" style="color:#FFA500;">${stats.pending}</div>
                    <div class="stat-label">üìã Pendientes</div>
                </div>
                <div class="stat-box">
                    <div class="stat-number" style="color:#00d9ff;">${stats.in_transit}</div>
                    <div class="stat-label">üöö En Camino</div>
                </div>
                <div class="stat-box">
                    <div class="stat-number" style="color:#00ff88;">${stats.delivered}</div>
                    <div class="stat-label">‚úÖ Entregados</div>
                </div>
            `;
            document.getElementById('stats').innerHTML = statsHtml;
            document.getElementById('stats').classList.remove('hidden');

            // Display orders
            const filterLabel = {
                'all': 'TODAS',
                'pending': 'üìã PENDIENTES',
                'in_transit': 'üöö EN CAMINO',
                'delivered': '‚úÖ ENTREGADAS'
            };

            let html = `<h2 style="margin-top:20px;">üèçÔ∏è ${orders.length} VENTAS FLEX - ${filterLabel[filterType]}</h2>`;

            if (orders.length === 0) {
                html += '<div class="error">No hay ventas con este filtro</div>';
            }

            orders.forEach(({ order, shipping }, index) => {
                html += `
                    <div class="order-card">
                        <div class="order-header">
                            <div class="order-id">üèçÔ∏è VENTA FLEX #${index + 1} - Order ID: ${order.id}</div>
                        </div>
                        
                        <div class="data-row">
                            <div class="data-label">Fecha Creaci√≥n:</div>
                            <div class="data-value">${order.date_created}</div>
                        </div>
                        
                        <div class="data-row">
                            <div class="data-label">Estado Orden:</div>
                            <div class="data-value">${order.status}</div>
                        </div>
                        
                        <div class="data-row">
                            <div class="data-label">Comprador:</div>
                            <div class="data-value">${order.buyer?.nickname || 'N/A'}</div>
                        </div>
                        
                        <div class="data-row">
                            <div class="data-label">Shipping ID:</div>
                            <div class="data-value">${shipping.id || 'N/A'}</div>
                        </div>
                        
                        <div class="data-row">
                            <div class="data-label">Estado Env√≠o:</div>
                            <div class="data-value">${shipping.status || 'N/A'} - ${shipping.substatus || 'N/A'}</div>
                        </div>
                        
                        <div class="data-row">
                            <div class="data-label">status_history:</div>
                            <div class="data-value">
                                shipped: ${shipping.status_history?.date_shipped || '‚ùå'}<br>
                                delivered: ${shipping.status_history?.date_delivered || '‚ùå'}<br>
                                handling: ${shipping.status_history?.date_handling || '‚ùå'}<br>
                                ready_to_ship: ${shipping.status_history?.date_ready_to_ship || '‚ùå'}
                            </div>
                        </div>
                        
                        <div class="data-row">
                            <div class="data-label">üìä ESTADO CATEGORIZADO:</div>
                            <div class="data-value" style="font-size: 16px; font-weight: bold;">
                                ${categorizeStatus(shipping)}
                            </div>
                        </div>
                        
                        <div class="data-row">
                            <div class="data-label">Direcci√≥n:</div>
                            <div class="data-value">
                                ${shipping.receiver_address?.street_name || ''} 
                                ${shipping.receiver_address?.street_number || ''}, 
                                ${shipping.receiver_address?.city?.name || ''}, 
                                ${shipping.receiver_address?.state?.name || ''}
                            </div>
                        </div>
                        
                        <details class="json-data">
                            <summary style="cursor:pointer; color:#FFE600;">üìÑ Ver JSON Completo (Orden)</summary>
                            <pre>${JSON.stringify(order, null, 2)}</pre>
                        </details>
                        
                        <details class="json-data">
                            <summary style="cursor:pointer; color:#0f0;">üì¶ Ver JSON Completo (Shipping)</summary>
                            <pre>${JSON.stringify(shipping, null, 2)}</pre>
                        </details>
                    </div>
                `;
            });

            document.getElementById('content').innerHTML = html;
        }

        async function cargarDatos() {
            const content = document.getElementById('content');
            content.innerHTML = '<div class="loading">Cargando √∫ltimas ventas...</div>';

            try {
                const response = await fetch(`${CONFIG.API_BASE}/orders/search?seller=${sellerId}&offset=0&limit=30&sort=date_desc`, {
                    headers: {
                        'Authorization': `Bearer ${accessToken}`
                    }
                });

                const data = await response.json();

                if (!data.results || data.results.length === 0) {
                    content.innerHTML = '<div class="error">No se encontraron ventas</div>';
                    return;
                }

                const ordersWithShipping = await Promise.all(
                    data.results.map(async (order) => {
                        try {
                            const shippingId = order.shipping?.id;
                            if (!shippingId) return { order, shipping: null };

                            const shipResponse = await fetch(`${CONFIG.API_BASE}/shipments/${shippingId}`, {
                                headers: {
                                    'Authorization': `Bearer ${accessToken}`
                                }
                            });

                            const shipping = await shipResponse.json();
                            return { order, shipping };
                        } catch (e) {
                            return { order, shipping: null };
                        }
                    })
                );

                let html = '<h2 style="margin-top:20px;">üìä √öLTIMAS 30 VENTAS:</h2>';

                ordersWithShipping.forEach(({ order, shipping }, index) => {
                    const shippingInfo = shipping || order.shipping || {};
                    
                    html += `
                        <div class="order-card">
                            <div class="order-header">
                                <div class="order-id">VENTA #${index + 1} - Order ID: ${order.id}</div>
                            </div>
                            
                            <div class="data-row">
                                <div class="data-label">Fecha Creaci√≥n:</div>
                                <div class="data-value">${order.date_created}</div>
                            </div>
                            
                            <div class="data-row">
                                <div class="data-label">Estado Orden:</div>
                                <div class="data-value">${order.status}</div>
                            </div>
                            
                            <div class="data-row">
                                <div class="data-label">Comprador:</div>
                                <div class="data-value">${order.buyer?.nickname || 'N/A'}</div>
                            </div>
                            
                            <div class="data-row">
                                <div class="data-label">logistic_type:</div>
                                <div class="data-value">${shippingInfo.logistic_type || 'N/A'}</div>
                            </div>
                            
                            <div class="data-row">
                                <div class="data-label">Estado Env√≠o:</div>
                                <div class="data-value">${shippingInfo.status || 'N/A'} - ${shippingInfo.substatus || 'N/A'}</div>
                            </div>
                            
                            <div class="data-row">
                                <div class="data-label">üéØ TIPO DE ENV√çO:</div>
                                <div class="data-value" style="font-size: 18px; font-weight: bold;">
                                    ${shippingInfo.logistic_type === 'self_service' ? 'üèçÔ∏è FLEX (MOTO)' : 
                                      shippingInfo.logistic_type === 'cross_docking' ? 'üìÆ COLECTA (CORREO)' : 
                                      '‚ùì OTRO'}
                                </div>
                            </div>
                            
                            <div class="data-row">
                                <div class="data-label">üìä ESTADO CATEGORIZADO:</div>
                                <div class="data-value" style="font-size: 16px;">
                                    ${categorizeStatus(shippingInfo)}
                                </div>
                            </div>
                            
                            <details class="json-data">
                                <summary style="cursor:pointer; color:#FFE600;">üìÑ Ver JSON</summary>
                                <pre>${JSON.stringify({order, shipping}, null, 2)}</pre>
                            </details>
                        </div>
                    `;
                });

                content.innerHTML = html;

            } catch (error) {
                content.innerHTML = `<div class="error">‚ùå Error: ${error.message}</div>`;
                console.error(error);
            }
        }

        function categorizeStatus(shipping) {
            const status = (shipping.status || '').toLowerCase();
            const substatus = (shipping.substatus || '').toLowerCase();

            if (status === 'delivered' || substatus === 'delivered') {
                return '‚úÖ ENTREGADO';
            }

            if (status === 'shipped' || status === 'handling' || 
                substatus === 'in_transit' || substatus === 'out_for_delivery' || 
                substatus === 'picked_up' || substatus === 'in_hub') {
                return 'üöö EN CAMINO';
            }

            if (status === 'ready_to_ship' || substatus === 'ready_to_print' || 
                substatus === 'printed') {
                return 'üìã PENDIENTE (Listo para enviar)';
            }

            if (status === 'cancelled' || status === 'canceled') {
                return '‚ùå CANCELADO';
            }

            if (substatus === 'delayed' || substatus === 'not_delivered' || 
                status === 'returned' || substatus === 'contact_buyer') {
                return '‚ö†Ô∏è PROBLEMA';
            }

            return `‚ùì DESCONOCIDO (${status} - ${substatus})`;
        }

        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
