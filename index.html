<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Debug - Datos de MercadoLibre</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: Arial, sans-serif;
            background: #1a1a1a;
            color: #fff;
            padding: 20px;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
        }
        
        h1 {
            color: #FFE600;
            margin-bottom: 20px;
        }
        
        button {
            background: #3483FA;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 16px;
            margin-bottom: 20px;
        }
        
        button:hover {
            background: #2968c8;
        }
        
        .order-card {
            background: #2a2a2a;
            border: 1px solid #444;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
        }
        
        .order-header {
            border-bottom: 2px solid #FFE600;
            padding-bottom: 10px;
            margin-bottom: 15px;
        }
        
        .order-id {
            font-size: 18px;
            font-weight: bold;
            color: #FFE600;
        }
        
        .data-row {
            display: grid;
            grid-template-columns: 200px 1fr;
            gap: 10px;
            padding: 8px 0;
            border-bottom: 1px solid #333;
        }
        
        .data-label {
            font-weight: bold;
            color: #aaa;
        }
        
        .data-value {
            color: #fff;
        }
        
        .json-data {
            background: #1a1a1a;
            border: 1px solid #444;
            border-radius: 4px;
            padding: 15px;
            margin-top: 15px;
            overflow-x: auto;
        }
        
        pre {
            color: #0f0;
            font-size: 12px;
            white-space: pre-wrap;
            word-wrap: break-word;
        }
        
        .loading {
            text-align: center;
            padding: 40px;
            font-size: 20px;
        }
        
        .error {
            background: #f44336;
            color: white;
            padding: 15px;
            border-radius: 6px;
            margin-bottom: 20px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîç DEBUG - Datos RAW de MercadoLibre</h1>
        <button onclick="conectar()">Conectar con MercadoLibre</button>
        <button onclick="cargarDatos()" id="loadBtn" style="display:none;">Cargar √öltimas Ventas</button>
        <button onclick="cargarEnCamino()" id="loadTransitBtn" style="display:none; background:#00d9ff;">üöö Cargar EN CAMINO</button>
        <button onclick="cargarEntregados()" id="loadDeliveredBtn" style="display:none; background:#00ff88;">‚úÖ Cargar ENTREGADOS</button>
        
        <div id="content"></div>
    </div>

    <script>
        const CONFIG = {
            CLIENT_ID: '6723747350775490',
            CLIENT_SECRET: 'IpbZNxEJHqaOqou9rVJWs6F2tlswCfX5',
            REDIRECT_URI: window.location.origin + window.location.pathname,
            API_BASE: 'https://mikra-flex-proxy.rafaelassir.workers.dev/api'
        };
        
        let accessToken = localStorage.getItem('ml_access_token');
        let sellerId = localStorage.getItem('ml_seller_id');
        
        function init() {
            const urlParams = new URLSearchParams(window.location.search);
            const code = urlParams.get('code');
            
            if (code) {
                handleAuthCallback(code);
            } else if (accessToken && sellerId) {
                document.getElementById('loadBtn').style.display = 'inline-block';
                document.getElementById('loadTransitBtn').style.display = 'inline-block';
                document.getElementById('loadDeliveredBtn').style.display = 'inline-block';
            }
        }
        
        function conectar() {
            const authUrl = `https://auth.mercadolibre.com.ar/authorization?response_type=code&client_id=${CONFIG.CLIENT_ID}&redirect_uri=${CONFIG.REDIRECT_URI}`;
            window.location.href = authUrl;
        }
        
        async function handleAuthCallback(code) {
            const content = document.getElementById('content');
            content.innerHTML = '<div class="loading">Autenticando...</div>';
            
            try {
                const response = await fetch(`${CONFIG.API_BASE}/oauth/token`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                    body: new URLSearchParams({
                        grant_type: 'authorization_code',
                        client_id: CONFIG.CLIENT_ID,
                        client_secret: CONFIG.CLIENT_SECRET,
                        code: code,
                        redirect_uri: CONFIG.REDIRECT_URI
                    })
                });
                
                const data = await response.json();
                accessToken = data.access_token;
                localStorage.setItem('ml_access_token', accessToken);
                
                // Get user ID
                const userResponse = await fetch(`${CONFIG.API_BASE}/users/me`, {
                    headers: { 'Authorization': `Bearer ${accessToken}` }
                });
                const userData = await userResponse.json();
                sellerId = userData.id;
                localStorage.setItem('ml_seller_id', sellerId);
                
                content.innerHTML = '<div class="loading">‚úÖ Conectado! Ahora carg√° las ventas</div>';
                document.getElementById('loadBtn').style.display = 'inline-block';
                document.getElementById('loadTransitBtn').style.display = 'inline-block';
                document.getElementById('loadDeliveredBtn').style.display = 'inline-block';
                
                // Remove code from URL
                window.history.replaceState({}, document.title, window.location.pathname);
                
            } catch (error) {
                content.innerHTML = `<div class="error">Error: ${error.message}</div>`;
            }
        }
        
     <script>
async function cargarDatos() {
    const content = document.getElementById('content');
    content.innerHTML = '<div class="loading">Cargando √∫ltimas 30 ventas FLEX (moto)...</div>';

    try {
        // 1Ô∏è‚É£ Traemos m√°s √≥rdenes para poder filtrar
        const response = await fetch(
            `${CONFIG.API_BASE}/orders/search?seller=${sellerId}&offset=0&limit=100&sort=date_desc`,
            { headers: { 'Authorization': `Bearer ${accessToken}` } }
        );

        const data = await response.json();
        if (!data.results?.length) {
            content.innerHTML = '<div class="error">No se encontraron ventas</div>';
            return;
        }

        // 2Ô∏è‚É£ Pedimos shipping de cada orden
        const ordersWithShipping = await Promise.all(
            data.results.map(async order => {
                if (!order.shipping?.id) return null;

                try {
                    const r = await fetch(
                        `${CONFIG.API_BASE}/shipments/${order.shipping.id}`,
                        { headers: { 'Authorization': `Bearer ${accessToken}` } }
                    );
                    const shipping = await r.json();
                    return { order, shipping };
                } catch {
                    return null;
                }
            })
        );

        // 3Ô∏è‚É£ FILTRO FLEX / MOTO
        const soloMoto = ordersWithShipping
            .filter(x =>
                x &&
                (
                    x.shipping.logistic_type === 'self_service' ||
                    x.shipping.shipping_method_id === 100009
                )
            )
            .slice(0, 30); // üëà √∫ltimas 30

        if (!soloMoto.length) {
            content.innerHTML = '<div class="error">No hay ventas FLEX (moto)</div>';
            return;
        }

        // 4Ô∏è‚É£ MOSTRAR
        let html = `<h2>üèçÔ∏è √öLTIMAS ${soloMoto.length} VENTAS FLEX (MOTO)</h2>`;

        soloMoto.forEach(({ order, shipping }, i) => {
            html += `
            <div class="order-card">
                <div class="order-header">
                    <div class="order-id">üèçÔ∏è FLEX #${i + 1} - Order ${order.id}</div>
                </div>

                <div class="data-row">
                    <div class="data-label">Fecha:</div>
                    <div class="data-value">${order.date_created}</div>
                </div>

                <div class="data-row">
                    <div class="data-label">Comprador:</div>
                    <div class="data-value">${order.buyer?.nickname || 'N/A'}</div>
                </div>

                <div class="data-row">
                    <div class="data-label">Shipping ID:</div>
                    <div class="data-value">${shipping.id}</div>
                </div>

                <div class="data-row">
                    <div class="data-label">Tipo:</div>
                    <div class="data-value" style="font-weight:bold;color:#0f0;">
                        üèçÔ∏è FLEX (self_service)
                    </div>
                </div>

                <div class="data-row">
                    <div class="data-label">Estado:</div>
                    <div class="data-value">${shipping.status} - ${shipping.substatus || ''}</div>
                </div>

                <div class="data-row">
                    <div class="data-label">Direcci√≥n:</div>
                    <div class="data-value">
                        ${shipping.receiver_address?.street_name || ''} 
                        ${shipping.receiver_address?.street_number || ''},
                        ${shipping.receiver_address?.city?.name || ''}
                    </div>
                </div>
            </div>
            `;
        });

        content.innerHTML = html;

    } catch (err) {
        console.error(err);
        content.innerHTML = `<div class="error">‚ùå Error: ${err.message}</div>`;
    }
}
</script>

        
        async function cargarEnCamino() {
            await cargarPorEstado('shipped,handling', 'üöö EN CAMINO');
        }
        
        async function cargarEntregados() {
            await cargarPorEstado('delivered', '‚úÖ ENTREGADOS');
        }
        
        async function cargarPorEstado(orderStatus, titulo) {
            const content = document.getElementById('content');
            content.innerHTML = `<div class="loading">Cargando ${titulo}...</div>`;
            
            try {
                // Get orders with shipping status filter
                // For "in transit": order.shipping.status = shipped or handling
                // For "delivered": tags include "delivered"
                
                let searchParams = `seller=${sellerId}&offset=0&limit=100`;
                
                // Add tag filter based on status
                if (orderStatus === 'delivered') {
                    searchParams += '&tags=delivered';
                } else if (orderStatus === 'shipped,handling') {
                    // For in transit, we need to get recent orders and filter
                    searchParams += '&sort=date_desc';
                }
                
                const response = await fetch(`${CONFIG.API_BASE}/orders/search?${searchParams}`, {
                    headers: { 'Authorization': `Bearer ${accessToken}` }
                });
                
                if (!response.ok) {
                    throw new Error(`Error ${response.status}`);
                }
                
                const data = await response.json();
                console.log('üì¶ DATOS COMPLETOS:', data);
                
                if (!data.results || data.results.length === 0) {
                    content.innerHTML = `<div class="error">No se encontraron √≥rdenes</div>`;
                    return;
                }
                
                // Get shipping details for each order
                const ordersWithShipping = await Promise.all(
                    data.results.map(async (order) => {
                        try {
                            const shippingId = order.shipping?.id;
                            if (!shippingId) return null;
                            
                            const shipResponse = await fetch(`${CONFIG.API_BASE}/shipments/${shippingId}`, {
                                headers: { 'Authorization': `Bearer ${accessToken}` }
                            });
                            const shipping = await shipResponse.json();
                            return { order, shipping };
                        } catch (e) {
                            return null;
                        }
                    })
                );
                
                // Filter by status if looking for in transit
                let filtered = ordersWithShipping.filter(item => item !== null);
                
                if (orderStatus === 'shipped,handling') {
                    filtered = filtered.filter(item => {
                        const status = item.shipping?.status?.toLowerCase() || '';
                        return status === 'shipped' || status === 'handling';
                    });
                }
                
                console.log(`Filtered ${filtered.length} shipments with status matching criteria`);
                
                if (filtered.length === 0) {
                    content.innerHTML = `<div class="error">No se encontraron env√≠os con estado: ${orderStatus}</div>`;
                    return;
                }
                
                // Display shipments
                let html = `<h2 style="margin-top:20px;">${titulo}: ${filtered.length} ENV√çOS</h2>`;
                
                filtered.forEach(({ order, shipping }, index) => {
                    html += `
                        <div class="order-card">
                            <div class="order-header">
                                <div class="order-id">ENV√çO #${index + 1} - Shipping ID: ${shipping.id}</div>
                            </div>
                            
                            <div class="data-row">
                                <div class="data-label">Order ID:</div>
                                <div class="data-value">${order.id || 'N/A'}</div>
                            </div>
                            
                            <div class="data-row">
                                <div class="data-label">Comprador:</div>
                                <div class="data-value">${order.buyer?.nickname || 'N/A'}</div>
                            </div>
                            
                            <div class="data-row">
                                <div class="data-label">Fecha Creaci√≥n:</div>
                                <div class="data-value">${shipping.date_created}</div>
                            </div>
                            
                            <div class="data-row">
                                <div class="data-label">logistic_type:</div>
                                <div class="data-value">${shipping.logistic_type || 'N/A'}</div>
                            </div>
                            
                            <div class="data-row">
                                <div class="data-label">Transportista:</div>
                                <div class="data-value">${shipping.shipping_option?.name || 'N/A'}</div>
                            </div>
                            
                            <div class="data-row">
                                <div class="data-label">Estado Env√≠o:</div>
                                <div class="data-value">${shipping.status || 'N/A'} - ${shipping.substatus || 'N/A'}</div>
                            </div>
                            
                            <div class="data-row">
                                <div class="data-label">substatus_history:</div>
                                <div class="data-value">
                                    ${shipping.substatus_history?.length || 0} eventos
                                    ${shipping.substatus_history?.length > 0 ? `<br>√öltimo: ${shipping.substatus_history[shipping.substatus_history.length - 1]?.substatus}` : ''}
                                </div>
                            </div>
                            
                            <div class="data-row">
                                <div class="data-label">status_history:</div>
                                <div class="data-value">
                                    shipped: ${shipping.status_history?.date_shipped || '‚ùå'}<br>
                                    delivered: ${shipping.status_history?.date_delivered || '‚ùå'}<br>
                                    handling: ${shipping.status_history?.date_handling || '‚ùå'}<br>
                                    ready_to_ship: ${shipping.status_history?.date_ready_to_ship || '‚ùå'}
                                </div>
                            </div>
                            
                            <div class="data-row">
                                <div class="data-label">üéØ TIPO DE ENV√çO:</div>
                                <div class="data-value" style="font-size: 18px; font-weight: bold;">
                                    ${shipping.logistic_type === 'self_service' ? 'üèçÔ∏è FLEX (MOTO)' : 
                                      shipping.logistic_type === 'cross_docking' ? 'üìÆ COLECTA (CORREO)' : 
                                      shipping.logistic_type === 'fulfillment' ? 'üè¢ FULL' :
                                      '‚ùì OTRO: ' + shipping.logistic_type}
                                </div>
                            </div>
                            
                            <div class="data-row">
                                <div class="data-label">üìä ESTADO CATEGORIZADO:</div>
                                <div class="data-value" style="font-size: 16px;">
                                    ${categorizeStatus(shipping)}
                                </div>
                            </div>
                            
                            <div class="data-row">
                                <div class="data-label">Direcci√≥n:</div>
                                <div class="data-value">
                                    ${shipping.receiver_address?.street_name || ''} 
                                    ${shipping.receiver_address?.street_number || ''}, 
                                    ${shipping.receiver_address?.city?.name || ''}, 
                                    ${shipping.receiver_address?.state?.name || ''}
                                </div>
                            </div>
                            
                            <details class="json-data">
                                <summary style="cursor:pointer; color:#0f0;">üì¶ Ver JSON Completo (Shipping)</summary>
                                <pre>${JSON.stringify(shipping, null, 2)}</pre>
                            </details>
                        </div>
                    `;
                });
                
                content.innerHTML = html;
                
            } catch (error) {
                content.innerHTML = `<div class="error">‚ùå Error: ${error.message}</div>`;
                console.error(error);
            }
        }
        
        function categorizeStatus(shipping) {
            const status = (shipping.status || '').toLowerCase();
            const substatus = (shipping.substatus || '').toLowerCase();
            
            // DELIVERED
            if (status === 'delivered' || substatus === 'delivered') {
                return '‚úÖ ENTREGADO';
            }
            
            // IN TRANSIT (shipped, handling, etc)
            if (status === 'shipped' || status === 'handling' || 
                substatus === 'in_transit' || substatus === 'out_for_delivery' ||
                substatus === 'picked_up' || substatus === 'in_hub') {
                return 'üöö EN CAMINO';
            }
            
            // READY TO SHIP (ready_to_print, printed, ready_to_ship)
            if (status === 'ready_to_ship' || 
                substatus === 'ready_to_print' || substatus === 'printed') {
                return 'üìã PENDIENTE (Listo para enviar)';
            }
            
            // CANCELLED
            if (status === 'cancelled' || status === 'canceled') {
                return '‚ùå CANCELADO';
            }
            
            // PROBLEM
            if (substatus === 'delayed' || substatus === 'not_delivered' ||
                status === 'returned' || substatus === 'contact_buyer') {
                return '‚ö†Ô∏è PROBLEMA';
            }
            
            // UNKNOWN
            return `‚ùì DESCONOCIDO (${status} - ${substatus})`;
        }
        
        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
